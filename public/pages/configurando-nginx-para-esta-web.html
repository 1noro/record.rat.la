<!-- 202009190140i -->
<h1>Un servidor para record.rat.la</h1>

<blockquote>
    <!-- Lo pongo en un blockquote para que la descripción del artículo siga siendo la misma -->
    <b>(ARTÍCULO DESACTUALIZADO)</b>
</blockquote>

<p>
    Como por el momento esta web será para uso personal, y no tendrá una enorme carga de trabajo, voy a optar por instalarla en una máquina virtual <a href="https://www.debian.org/index.es.html">Debian</a> 10 en mi servidor <a href="https://www.proxmox.com/en/">Proxmox</a>.
</p>

<p>
    Aprovechando que siempre quise tener una web bajo un servidor <a href="https://www.nginx.com/">Nginx</a> en ved de <a href="https://httpd.apache.org/">Apache2</a>, voy a utilizar esta oportunidad para aprender.
</p>

<p>
    Como primer paso voy a descargar mi web en el directorio <samp>/var/wwww</samp>.
</p>

<pre>
cd /var/wwww
git clone https://github.com/1noro/record.rat.la.git
chmod 777 -R record.rat.la.git
</pre>

<h2>Configurando Nginx en Debian 10</h2>

<pre>
apt install git nginx php-fpm
</pre>

<p>
    En el archivo <samp>/etc/php/7.3/fpm/php.ini</samp> cambiamos <code>;cgi.fix_pathinfo=1</code> por <code>cgi.fix_pathinfo=0</code>.
</p>

<pre>
systemctl restart php7.3-fpm.service
</pre>

<p>
    Hacemos una copia de seguridad del archivo <samp>/etc/nginx/sites-available/default</samp> antes de modificarlo.
</p>

<p>
    Tomando como referencia <samp>/etc/nginx/sites-available/default</samp> creamos <samp>/etc/nginx/conf.d/record.rat.la.conf</samp>.
</p>

<pre>
cp /etc/nginx/sites-available/default /etc/nginx/conf.d/record.rat.la.conf
</pre>

<p>
    Luego comentamos todas las lineas de <samp>/etc/nginx/sites-available/default</samp> para que quede "vacío".
</p>

<p>
    Ahora editamos <samp>/etc/nginx/conf.d/record.rat.la.conf</samp>.
</p>

<h3><samp>record.rat.la.conf</samp> original</h3>

<pre>
server {
    listen 80 default_server;
    listen [::]:80 default_server;

    # SSL configuration
    #
    # listen 443 ssl default_server;
    # listen [::]:443 ssl default_server;
    #
    # Note: You should disable gzip for SSL traffic.
    # See: https://bugs.debian.org/773332
    #
    # Read up on ssl_ciphers to ensure a secure configuration.
    # See: https://bugs.debian.org/765782
    #
    # Self signed certs generated by the ssl-cert package
    # Don't use them in a production server!
    #
    # include snippets/snakeoil.conf;

    root /var/www/html;

    # Add index.php to the list if you are using PHP
    index index.html index.htm index.nginx-debian.html;

    server_name _;

    location / {
        # First attempt to serve request as file, then
        # as directory, then fall back to displaying a 404.
        try_files $uri $uri/ =404;
    }

    # pass PHP scripts to FastCGI server
    #
    #location ~ \.php$ {
    #    include snippets/fastcgi-php.conf;
    #
    #    # With php-fpm (or other unix sockets):
    #    fastcgi_pass unix:/run/php/php7.3-fpm.sock;
    #    # With php-cgi (or other tcp sockets):
    #    fastcgi_pass 127.0.0.1:9000;
    #}

    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    #
    #location ~ /\.ht {
    #    deny all;
    #}
}


# Virtual Host configuration for example.com
#
# You can move that to a different file under sites-available/ and symlink that
# to sites-enabled/ to enable it.
#
#server {
#   listen 80;
#   listen [::]:80;
#
#   server_name example.com;
#
#   root /var/www/example.com;
#   index index.html;
#
#   location / {
#       try_files $uri $uri/ =404;
#   }
#}
</pre>

<h3>Modificaciones</h3>

<ul>
    <li>En primer lugar, necesitamos agregar <samp>index.php</samp> como el primer valor de nuestra directiva de índice para que los archivos denominados <samp>index.php</samp> se sirvan, si están disponibles, cuando se solicita un directorio.</li>
    <li>Podemos modificar la directiva <code>server_name</code> para apuntar al nombre de dominio de nuestro servidor o a la dirección IP pública.</li>
    <li>Para el procesamiento real de PHP, solo necesitamos descomentar un segmento del archivo que maneja las solicitudes de PHP. Éste será el bloque de ubicación <code>~.php$</code>, el fragmento <samp>fastcgi-php.conf</samp> incluido y el socket asociado con <code>php-fpm</code>.</li>
    <li>También hay que remover los comentarios del bloque de ubicación que trata con archivos <samp>.htaccess</samp>. Nginx no procesa estos archivos. Si alguno de estos archivos encuentra la forma de llegar a un documento root, no deben ser servidos a los visitantes.</li>
</ul>

<h3><samp>record.rat.la.conf</samp> modificado</h3>

<pre>
server {
    listen 80 default_server;
    listen [::]:80 default_server;

    # SSL configuration
    #
    # listen 443 ssl default_server;
    # listen [::]:443 ssl default_server;
    #
    # Note: You should disable gzip for SSL traffic.
    # See: https://bugs.debian.org/773332
    #
    # Read up on ssl_ciphers to ensure a secure configuration.
    # See: https://bugs.debian.org/765782
    #
    # Self signed certs generated by the ssl-cert package
    # Don't use them in a production server!
    #
    # include snippets/snakeoil.conf;

    root /var/www/record.rat.la;

    # Add index.php to the list if you are using PHP
    index index.php index.html index.htm index.nginx-debian.html;

    server_name record.rat.la;

    location / {
        # First attempt to serve request as file, then
        # as directory, then fall back to displaying a 404.
        try_files $uri $uri/ =404;
    }

    # pass PHP scripts to FastCGI server
    #
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;

        # With php-fpm (or other unix sockets):
        fastcgi_pass unix:/run/php/php7.3-fpm.sock;
        # With php-cgi (or other tcp sockets):
        #fastcgi_pass 127.0.0.1:9000;
    }

    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    #
    location ~ /\.ht {
        deny all;
    }
}


# Virtual Host configuration for example.com
#
# You can move that to a different file under sites-available/ and symlink that
# to sites-enabled/ to enable it.
#
#server {
#   listen 80;
#   listen [::]:80;
#
#   server_name example.com;
#
#   root /var/www/example.com;
#   index index.html;
#
#   location / {
#        try_files $uri $uri/ =404;
#   }
#}
</pre>

<p>Probamos la configuración y recargamos nginx.</p>

<pre>
nginx -t
systemctl reload nginx
</pre>

<h2>SSL con Lets Encrypt y Nginx en Debian 10</h2>

<p>Instalaciones iniciales:</p>

<pre>
apt install python3-acme python3-certbot python3-mock python3-openssl python3-pkg-resources python3-pyparsing python3-zope.interface
apt install python3-certbot-nginx
</pre>

<p>Con el <i>Virtual Host</i> correctamente configurado en Nginx (como se indica en el apartado anterior), ejecutamos el <samp>certbot</samp></p>

<pre>
certbot --nginx -d record.rat.la
</pre>

<p>Respondemos a todas las preguntas a nuestro gusto y al final aparece esto:</p>

<pre>
IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at:
   /etc/letsencrypt/live/record.rat.la/fullchain.pem
   Your key file has been saved at:
   /etc/letsencrypt/live/record.rat.la/privkey.pem
   Your cert will expire on 2020-12-18. To obtain a new or tweaked
   version of this certificate in the future, simply run certbot again
   with the "certonly" option. To non-interactively renew *all* of
   your certificates, run "certbot renew"
 - Your account credentials have been saved in your Certbot
   configuration directory at /etc/letsencrypt. You should make a
   secure backup of this folder now. This configuration directory will
   also contain certificates and private keys obtained by Certbot so
   making regular backups of this folder is ideal.
 - If you like Certbot, please consider supporting our work by:

   Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
   Donating to EFF:                    https://eff.org/donate-le
</pre>

<p>Si volvemos a <samp>record.rat.la.conf</samp> veremos que <samp>certbot</samp> ha agregado unas lineas a nuestra configuración.</p>

<pre>
listen [::]:443 ssl ipv6only=on; # managed by Certbot
listen 443 ssl; # managed by Certbot
ssl_certificate /etc/letsencrypt/live/record.rat.la/fullchain.pem; # managed by Certbot
ssl_certificate_key /etc/letsencrypt/live/record.rat.la/privkey.pem; # managed by Certbot
include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
</pre>

<h3>SSL Certbot Auto-Renewal</h3>

<p>Nos aseguramos de que cron se está ejecutando.</p>

<pre>
systemctl enable cron
systemctl start cron
</pre>

<p>Una vez instalado <samp>certbot</samp> se agrega automáticamente a <samp>cron</samp> para ejecutarse dos veces al día. De todas formas podemos probar que esto funciona correctamente ejecutando un simulacro de renovación.</p>

<pre>
certbot renew --dry-run
</pre>

<h2>Script para actualizar la web desde mi PC personal</h2>

<p>Para facilitar la actualización de la web, este script puede ser muy útil.</p>

<pre>
ssh user@server_ip_or_domain 'git -C /var/www/record.rat.la pull'
</pre>

<h2>Habilitar el header HTTP <em>charset</em> UTF-8</h2>

<p>
    Editamos el archivo <samp>/etc/nginx/nginx.conf</samp> y agregamos la siguiente línea a la configuración del bloque <samp>http</samp>.
</p>

<pre>
charset UTF-8;
</pre>

<p>
    Guarda el archivo y recarga/reinicia el servicio.
</p>

<pre>
nginx -t
systemctl reload nginx
</pre>

<h2>Bibliografía</h2>

<ul>
    <li><a href="https://www.digitalocean.com/community/tutorials/como-instalar-linux-nginx-mysql-php-lemp-stack-in-ubuntu-16-04-es">¿Cómo Instalar Linux, Nginx, MySQL, PHP (LEMP stack) in Ubuntu 16.04?</a></li>
    <li><a href="https://www.nginx.com/blog/using-free-ssltls-certificates-from-lets-encrypt-with-nginx/">Update: Using Free Let’s Encrypt SSL/TLS Certificates with NGINX</a></li>
    <li><a href="https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-debian-10">How To Secure Nginx with Let's Encrypt on Debian 10</a></li>
    <li><a href="https://stackoverflow.com/questions/7622616/executing-a-git-pull-from-a-different-directory">Executing a git pull from a different directory</a></li>
    <li><a href="https://malcontentcomics.com/systemsboy/2006/07/send-remote-commands-via-ssh.html">Send Remote Commands Via SSH</a></li>
    <li><a href="https://www.howtoforge.com/make-browsers-cache-static-files-on-nginx">Make Browsers Cache Static Files On nginx</a></li>
    <li><a href="https://www.cyberciti.biz/faq/nginx-set-http-content-type-response-header-to-charset-utf8/">How do I enable charset HTTP-header in Nginx?</a></li>
</ul>
