<h2>Un servidor para record.rat.la</h2>

<p>
    Como por el momento esta web será para uso personal, y no tendrá una enorme carga de trabajo, voy a optar por instalarla en una máquina virtual <a href="#">Debian</a> 10 en mi servidor <a href="#">Proxmox</a>.
</p>

<p>
    Aprovechando que siempre quise tener una web bajo un servidor <a href="#">Nginx</a> en ved de <a href="#">Apache2</a>, voy a utilizar esta oportunidad para aprender.
</p>

<p>
    Como primer paso voy a descargar mi web en el directorio <samp>/var/wwww</samp>.
</p>

<pre>
cd /var/wwww
git clone https://github.com/1noro/record.rat.la.git
chmod 777 -R record.rat.la.git
</pre>

<h3>Configurando Nginx</h3>

<pre>
apt install git nginx php-fpm
</pre>

<p>
    En el archivo <samp>/etc/php/7.3/fpm/php.ini</samp> cambiamos <code>;cgi.fix_pathinfo=1</code> por <code>cgi.fix_pathinfo=0</code>.
</p>

<pre>
systemctl restart php7.3-fpm.service
</pre>

<p>
    Hacemos una copia de seguridad del archivo <samp>/etc/nginx/sites-available/default</samp> antes de modificarlo.
</p>

<h4>Archivo original</h4>

<pre>
server {
        listen 80 default_server;
        listen [::]:80 default_server;

        # SSL configuration
        #
        # listen 443 ssl default_server;
        # listen [::]:443 ssl default_server;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        # include snippets/snakeoil.conf;

        root /var/www/html;

        # Add index.php to the list if you are using PHP
        index index.html index.htm index.nginx-debian.html;

        server_name _;

        location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ =404;
        }

        # pass PHP scripts to FastCGI server
        #
        #location ~ \.php$ {
        #       include snippets/fastcgi-php.conf;
        #
        #       # With php-fpm (or other unix sockets):
        #       fastcgi_pass unix:/run/php/php7.3-fpm.sock;
        #       # With php-cgi (or other tcp sockets):
        #       fastcgi_pass 127.0.0.1:9000;
        #}

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #       deny all;
        #}
}


# Virtual Host configuration for example.com
#
# You can move that to a different file under sites-available/ and symlink that
# to sites-enabled/ to enable it.
#
#server {
#       listen 80;
#       listen [::]:80;
#
#       server_name example.com;
#
#       root /var/www/example.com;
#       index index.html;
#
#       location / {
#               try_files $uri $uri/ =404;
#       }
#}
</pre>

<h4>Modificaciones</h4>

<ul>
    <li>En primer lugar, necesitamos agregar <code>index.php</code> como el primer valor de nuestra directiva de índice para que los archivos denominados <code>index.php</code> se sirvan, si están disponibles, cuando se solicita un directorio.</li>
    <li>Podemos modificar la directiva <code>server_name</code> para apuntar al nombre de dominio de nuestro servidor o a la dirección IP pública.</li>
    <li>Para el procesamiento real de PHP, solo necesitamos descomentar un segmento del archivo que maneja las solicitudes de PHP. Éste será el bloque de ubicación <code>~.php$</code>, el fragmento <code>fastcgi-php.conf</code> incluido y el socket asociado con <code>php-fpm</code>.</li>
    <li>También hay que remover los comentarios del bloque de ubicación que trata con archivos <code>.htaccess</code>. Nginx no procesa estos archivos. Si alguno de estos archivos encuentra la forma de llegar a un documento root, no deben ser servidos a los visitantes.</li>
</ul>

<h4>Archivo modificado</h4>

<pre>
server {
        listen 80 default_server;
        listen [::]:80 default_server;

        # SSL configuration
        #
        # listen 443 ssl default_server;
        # listen [::]:443 ssl default_server;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        # include snippets/snakeoil.conf;

        root /var/www/record.rat.la;

        # Add index.php to the list if you are using PHP
        index index.php index.html index.htm index.nginx-debian.html;

        server_name record.rat.la;

        location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ =404;
        }

        # pass PHP scripts to FastCGI server
        #
        location ~ \.php$ {
                include snippets/fastcgi-php.conf;

                # With php-fpm (or other unix sockets):
                fastcgi_pass unix:/run/php/php7.3-fpm.sock;
                # With php-cgi (or other tcp sockets):
                #fastcgi_pass 127.0.0.1:9000;
        }

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        location ~ /\.ht {
                deny all;
        }

}


# Virtual Host configuration for example.com
#
# You can move that to a different file under sites-available/ and symlink that
# to sites-enabled/ to enable it.
#
#server {
#       listen 80;
#       listen [::]:80;
#
#       server_name example.com;
#
#       root /var/www/example.com;
#       index index.html;
#
#       location / {
#               try_files $uri $uri/ =404;
#       }
#}
</pre>

<p>Probamos la configuración y recargamos nginx.</p>

<pre>
nginx -t
systemctl reload nginx
</pre>

<h3>SSL con Lets Encrypt y Nginx</h3>

<p>...</p>

<h3>Script para actualizar la web desde mi PC personal</h3>

<p>...</p>

<h3>Bibliografía</h3>

<ul>
    <li><a href="https://www.digitalocean.com/community/tutorials/como-instalar-linux-nginx-mysql-php-lemp-stack-in-ubuntu-16-04-es">¿Cómo Instalar Linux, Nginx, MySQL, PHP (LEMP stack) in Ubuntu 16.04?</a></li>
</ul>
